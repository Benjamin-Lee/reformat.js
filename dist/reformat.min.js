function getGIs(e){for(var t="",n=0;n<e.length;n++)"gi|"==e[n].name.substring(0,3)&&(t+=e[n].name.substring(3).split("|")[0],t+="\n");return t}function getAccessionVersion(e){for(var t="",n=0;n<e.length;n++){var r=e[n].name.split(/\s/g);r[0].toUpperCase().match("GI")||(t+=r[0],t+="\n")}return t}function chunkString(e,t){for(var n,r=Math.ceil(e.length/t),s=new Array(r),a=0;r>a;a++)n=a*t,s[a]=e.substring(n,n+t);return s}function _contains(e,t){return-1!=="".indexOf.call(e,t,0)}function clustalParser(e){var t,n,r,s,a,i,o,l,h,f,u,c,g,p;if(g=[],l="[object Array]"===Object.prototype.toString.call(e)?e:e.split("\n"),l[0].slice(0,6)===!1)throw new Error("Invalid CLUSTAL Header");for(r=0,t=1,c=0;r<l.length;)r++,o=l[r],null!=o&&0!==o.length&&0!==o.trim().length?_contains(o,"*")||(1===t&&(c=0,t=0),u=/^(?:\s*)(\S+)(?:\s+)(\S+)(?:\s*)(\d*)(?:\s*|$)/g,h=u.exec(o),null!=h&&(i=h[1],a=i,p=h[2],c>=g.length?(f=getMeta(i),i=f.name,n=new model(p,i,c),n.untrimmed=a,n.ids=f.ids||{},n.details=f.details||{},s=Object.keys(n.ids),s.length>0&&(n.id=n.ids[s[0]]),g.push(n)):g[c].seq+=p,c++)):t=1;return g}function getMeta(e){var t,n,r=!1,s=!1,a={},i={},o=e.split(" ");if(o.length>=1?(r=o.shift(),s=o.join(" ")):r=e,r){var l=r.split("|");for(t=l.pop(),i.en=t;0!=l.length;){var h=l.shift(),f=l.shift();a[h]=f}}else t=r;if(s){var u=s.split("=");if(u.length>1){var c,g;u.length-1;u.forEach(function(e){e=e.trim();var t,r=e.split(" ");if(r.length>1?(g=r.pop(),t=r.join(" ")):t=e,c){var s=c.toLowerCase();i[s]=t}else n=t;c=g})}else n=u.shift()}var p={name:t,ids:a,details:i};return n&&(p.desc=n),p}function model(e,t,n){this.seq=e,this.name=t,this.id=n,this.ids={}}function validateFasta(e){if(!e)return!1;var t=e.split("\n");if(!t[0].startsWith("#")&&t[0].startsWith(">")){if(!e.startsWith(">"))return!1;if(-1==e.indexOf(">"))return!1;for(var n=e.split(">"),r=1;r<n.length;r++){if(";"==n[r].charAt(4))return!1;var s=">"+n[r];s=s.trim();var a=s.split("\n");if(">"==s[0]&&a.splice(0,1),s=a.join("").trim(),/[^\-\\ABCDEFGHIKLMNPQRSTUVWXYZ\s]/i.test(s))return!1}return!0}return!1}function validateClustal(e){if(!e)return!1;var t,n,r,s,a,i;e=e.split("\n"),n=!1;var o=clustalParser(e);for(r=0,s=e.length;s>r;r++)if(i=e[r],!i.match(/^\s*$/))if(n===!0){if(i=i.trim(),a=i.split(/\s+/g),2!==a.length&&3!==a.length)return console.log("Each line has to include name/sequence and optional length"),!1;if(a[1].length>60)return console.log("More than 60 sequence symbols in one line"),!1}else{if(t=i.trim().replace(" ",""),!t.startsWith("CLUSTAL"))return console.log("No CLUSTAL Header"),!1;for(var l=1;l<o.length;l++){if(o[l].seq.length!==o[l-1].seq.length)return console.log("input is not an alignment"),!1;if(/[^\-\\.ABCDEFGHIKLMNPQRSTUVWXYZ\s]/i.test(o[l].seq))throw new Error("Alignment contains invalid symbols.")}n=!0}return!0}function aminoCount(e){var t;t=new Uint32Array(91);for(var n=0;n<t.byteLength;n++)t[e.charCodeAt(n)]+=1;return t}function lowerCase(e){for(var t=0;t<e.length;t++)e[t].seq=e[t].seq.toLowerCase();return e}function upperCase(e){for(var t=0;t<e.length;t++)e[t].seq=e[t].seq.toUpperCase();return e}function conservation(e){}function getNumberOfFastaSeqs(e){var t=readFastaText(e);return t.length}function addSpaceEveryNChars(e,t){var n,r,s="";for(n=0,r=e.length;r>n;n+=t)s+=e.substr(n,t),s+=" ";return s}function validateAlignment(e){if(!e)throw new Error("No sequences.");if(e.length<2)throw new Error("Alignment needs at least two sequences");for(var t=e[0].seq.length,n=0;n<e.length;n++){if(e[n].seq.length!==t)throw new Error("Sequences are required to have the same length.");if(""==e[n].seq)throw new Error("Alignment contains an empty sequence.")}return console.log("this is an alignment"),!0}function json2fasta(e){for(var t="",n=0;n<e.length;n++)t+=">",t+=e[n].name,t+="\n",t+=formatLongSeq(e[n].seq,60),t+="\n";return t}function fasta2json(e){for(var t,n=e.split("\n"),n=n.filter(Boolean),r=[],s=0;s<n.length;){for(t={},t.name="",n[s].startsWith(">")&&(t.name=n[s].substring(1)),s++,t.seq="";s<n.length&&!n[s].startsWith(">");)n[s].startsWith(";")||(t.seq+=n[s]),s++;r.push(t)}return r}function validatePhylip(e){if(!e)return!1;var t,n,r,s;if(t=e.split("\n"),t=t.filter(Boolean),n=t[0].match(/\S+/g),t[0].startsWith(" ")||t[0].startsWith("	")){if(r=n[0],s=n[1],n.length<2||1>r||1>s||parseInt(r)<=0||parseInt(s)<=0)throw new Error("Incorrect header.");if(t.shift(),t.length%r!=0)return!1;for(var a=[],i=0;r>i;i++)t[i]=t[i].replace(/\s/g,""),a[i]=t[i].substring(10);for(var i=r,o=0;i<t.length&&t.length>r;i++,o++)i%r==0&&(o=0),t[i]=t[i].replace(/\s/g,""),a[o]+=t[i];for(var i=0;r>i;i++){if(/[^\-\\.ABCDEFGHIKLMNPQRSTUVWXYZ\s]/i.test(a[i]))throw new Error("Alignment contains invalid symbols.");if(a[i].length!=s)throw new Error("Number of sequence does not match with the header.")}return!0}return!1}function json2phylip(e){if(!e)return!1;var t,n,r,s="";t=e.length,n=e[0].seq.length,s+="	",s+=t,s+="	",s+=n;for(var a=0;t>a;a++){if(s+="\n",s+=e[a].name.substring(0,10),s+=" ",e[a].name.substring(0,10).length<10)for(var i=0;i<10-e[a].name.substring(0,9).length;i++)s+=" ";r=e[a].seq.match(/.{1,60}/g),s+=addSpaceEveryNChars(r[0],10)}for(var i=1;i<r.length;i++){s+="\n\n";for(var a=0;t>a;a++)r=e[a].seq.match(/.{1,60}/g),s+="           ",s+=addSpaceEveryNChars(r[i],10),s+="\n"}return s+="\n",s+="\n"}function phylip2json(e){if(!e)return!1;var t,n,r,s=[],a={};t=e.split("\n"),t=t.filter(Boolean),n=t[0].match(/\S+/g),r=n[0],t.shift();for(var i=0;r>i;i++){var a={};t[i]=t[i].replace(/\s/g,""),a.name=t[i].substring(0,9),a.seq=t[i].substring(10),s.push(a)}for(var i=r,o=0;i<t.length;i++,o++)i%r==0&&(o=0),t[i]=t[i].replace(/\s/g,""),s[o].seq+=t[i];return s}function validateStockholm(e){var t,n,r,s=[];if(!e)return!1;if(t=e.split("\n"),t[0].startsWith("# STOCKHOLM 1.0")&&t.length>1){t=t.filter(Boolean);for(var a=1;a<t.length&&!t[a].startsWith("//");a++)if(!t[a].startsWith("#")){if(n=t[a].split(/\s/g),n=n.filter(Boolean),n.length<2)throw new Error("Sequence or sequence name invalid.");if(r={},r.seq=n[1],/[^\-\\.ABCDEFGHIKLMNPQRSTUVWXYZ\s]/i.test(r.seq))throw new Error("Alignment contains invalid symbols.");s.push(r)}return!0}return!1}function json2stockholm(e){var t="";t+="# STOCKHOLM 1.0",t+="\n",t+="#GF SQ "+e.length,t+="\n";for(var n=0;n<e.length;n++)t+="#GF "+e[n].name.replace(/\s/g,"")+" DE "+e[n].name,t+="\n",t+=e[n].name.replace(/\s/g,""),t+=" 	",t+=e[n].seq,t+="\n";return t}function stockholm2json(e){var t,n,r,s=[];t=e.split("\n"),t=t.filter(Boolean);for(var a=0;a<t.length;a++)if(!t[a].startsWith("#")){if(t[a].startsWith("//"))break;n={},n.seq="",n.name="",r=t[a].split(/\s/g),r=r.filter(Boolean),n.name=r[0],n.seq=r[1],s.push(n)}return s}function clustal2json(e){if(!e)return!1;var t,n,r,s,a,i,o,l,h,f,u,c,g,p;for(l="[object Array]"===Object.prototype.toString.call(e)?e:e.split("\n"),g=[],r=0,t=1,c=0;r<l.length;)r++,o=l[r],null!=o&&0!==o.length&&0!==o.trim().length?_contains(o,"*")||(1===t&&(c=0,t=0),u=/^(?:\s*)(\S+)(?:\s+)(\S+)(?:\s*)(\d*)(?:\s*|$)/g,h=u.exec(o),null!=h?(i=h[1],a=i,p=h[2],c>=g.length?(f=getMeta(i),i=f.name,n=new model(p,i,c),n.untrimmed=a,n.ids=f.ids||{},n.details=f.details||{},s=Object.keys(n.ids),s.length>0&&(n.id=n.ids[s[0]]),g.push(n)):g[c].seq+=p,c++):console.log("clustal parse error")):t=1;return g}function json2clustal(e){if(!e)return!1;var t=[],n=0,r=0,s=[];for(t+="CLUSTAL multiple sequence alignment",t+="\n\n";r<Math.trunc(e[n].seq.length/60)+1;r++){for(;n<e.length;n++)s=e[n].name.split(/\s/g),t+=s[0],t+="	",t+=chunkString(e[n].seq,60)[r],t+="\n";t+="\n\n",n=0}return t+="\n"}function a3m2json(e){for(var t,n,r,s,a=e.split("\n"),i=0;i<a.length;i++)(a[i].match(/>/g)||[]).length>1&&(a[i]=a[i].replace(/(?!^)>/g,""));for(e=a.join("\n"),n=e.split(">"),s=[],r=1;r<n.length;r++)t={},t.name=readA3mLine(n[r]).name,t.seq=readA3mLine(n[r]).seq,s.push(t);return s}function json2a3m(e){for(var t="",n=0;n<e.length;n++)t+=">",t+=e[n].name,t+="\n",t+=formatLongSeq(e[n].seq.split(".").join("")),t+="\n";return t}function validatea3m(e){if(!e)return!1;if(!validateFasta(e)){var t=e.split("\n");t=t.filter(Boolean);for(var n=fasta2json(e),r=0;r<n.length;r++){if(!t[r].startsWith(">"))return!1;if(/[^\-\\.ABCDEFGHIKLMNPQRSTUVWXYZ\s]/i.test(n[r].seq))return!1;if(n[r].seq.indexOf(".")>-1)return!0}}return!1}function pir2json(e){if(!e)return!1;for(var t,n=e.split("\n"),n=n.filter(Boolean),r=[],s=0;s<n.length;){for(t={},t.name="",n[s].startsWith(">")&&(t.name=n[s].substring(1),t.description+=n[+s+1]),s++,s++,t.seq="";s<n.length&&!n[s].startsWith(">");)n[s].startsWith(";")||(t.seq+=n[s].slice(0,-1)),s++;r.push(t)}return r}function json2pir(e){for(var t="",n=0;n<e.length;n++)t+=">XX;",t+=e[n].name,t+="\n",e[n].description?(t+=e[n].description,t+="\n"):(t+="No description.",t+="\n"),t+=formatLongSeq(e[n].seq,60),t+="*",t+="\n";return t}function validatePir(e){if(!e)return!1;for(var t=pir2json(e),n=0;n<t.length;n++){if(";"!=t[n].name.charAt(2))return!1;if(/[^\-\\.\\*ABCDEFGHIKLMNPQRSTUVWXYZ\s]/i.test(t[n].seq))throw new Error("Alignment contains invalid symbols.")}for(var r=e.split(">"),r=r.filter(Boolean),n=0;n<r.length;n++)if(r[n]=r[n].replace(/\s/g,""),!r[n].endsWith("*"))return!1;return!0}function formatLongSeq(e,t){var n,r="";n=e.match(/.{1,60}/g);for(var s=0;s<n.length;s++)r+=n[s],s!=n.length-1&&(r+="\n");return r}function validateEMBL(e){if(!e)return!1;var t,n;if(t=e.split("\n"),t=t.filter(Boolean),t[0].startsWith("ID")&&t[t.length-1].endsWith("//")){n=embl2json(e);for(var r=0;r<n.length;r++){if(""==n[r].seq)return!1;if(""==n[r].name)return!1;if(/[^\-\\.ABCDEFGHIKLMNPQRSTUVWXYZ\s]/i.test(n[r].seq))throw new Error("Alignment contains invalid symbols.")}return!0}return!1}function embl2json(e){if(!e)return!1;var t,n=[],r=e.split("\n");r=r.filter(Boolean);for(var s=0;s<r.length;s++){for(t={};+s+1<r.length&&!r[+s+1].startsWith("ID");){if(r[s].startsWith("ID")&&(t.name="",t.name+=r[s].substring(5)),r[s].startsWith("DE")&&(t.description="",t.description+=r[s].substring(5)),r[s].startsWith("SQ"))for(t.seq="";+s+1<r.length&&!r[+s+1].startsWith("//");)s++,t.seq+=r[s].replace(/\s/g,"").replace(/[0-9]/g,"").toUpperCase();s++}n.push(t)}return n}function json2embl(e){for(var t,n="",r=0;r<e.length;r++){n+="ID   ",n+=e[r].name.split(/\s/g)[0]+"; ; ; ; ; "+e[r].seq.length+" BP.",n+="\n",n+="XX",n+="\n";var s=e[r].name.split(/\s/g);s.shift(),s=s.join(" "),(""!=s||e[r].description)&&(n+="DE   ",n+=s,e[r].description&&(n+=" "+e[r].description),n+="\n",n+="XX",n+="\n"),t=aminoCount(e[r].seq),n+="SQ   Sequence "+e[r].seq.length+" BP; ",n+=t["A".charCodeAt()]+" A; ",n+=t["C".charCodeAt()]+" C; ",n+=t["G".charCodeAt()]+" G; ",n+=t["T".charCodeAt()]+" T; ";for(var a=0,i=0;i<t.length;i++)i!="A".charCodeAt()&&i!="C".charCodeAt()&&i!="G".charCodeAt()&&i!="T".charCodeAt()&&(a+=t[i]);n+=a+" others; ",n+="\n",n+=formatEmblSeq(e[r].seq).toLowerCase(),n+="\n",n+="//",n+="\n"}return n}function formatEmblSeq(e){var t,n,r="";t=e.match(/.{1,60}/g),n=0;for(var s=0;s<t.length;s++){r+="     "+addSpaceEveryNChars(t[s],10);for(var a=80-t[s].length-5-(n+t[s].length).toString().length-(""+(t[s].length-1))[0],i=0;a>i;i++)r+=" ";n+=t[s].length,r+=n,s!=t.length-1&&(r+="\n")}return r}function validateNexus(e){if(!e)return!1;var t,n,r,s=e.split("\n");if(s=s.filter(Boolean),!e.startsWith("#NEXUS"))return!1;if(!s[1].toUpperCase().startsWith("BEGIN"))return!1;if(!s[s.length-1].toUpperCase().startsWith("END;"))return!1;t=nexus2json(e);var a=s[2].toUpperCase().replace("NTAX="," ").replace("DIMENSIONS","").replace("NCHAR="," ").replace(";"," ");if(n=a.split(/\s/g).filter(Boolean)[0],r=a.split(/\s/g).filter(Boolean)[1],n!=t.length)throw new Error("Number of sequences does not match with the header.");for(var i=0;i<t.length;i++){if(/[^\-\\.ABCDEFGHIKLMNPQRSTUVWXYZ\s]/i.test(t[i].seq))throw new Error("Sequence contains invalid symbols.");if(r!=t[i].seq.length)throw new Error("Number of sequences does not match with the header.")}for(var i=0;i<t.length;i++){if(t[i].name="")return!1;if(t[i].seq="")return!1}return!0}function nexus2json(e){if(!e)return!1;var t,n=[],r=e.split("\n"),s=[];r=r.filter(Boolean),r.shift();for(var a=0;a<r.length;a++)if(r[a].toUpperCase().startsWith("MATRIX")){for(;+a+1<r.length&&!r[+a+1].startsWith(";");)t={},a++,t.name=r[a].split(/\s/g)[0],s=r[a].split(/\s/g),s.shift(),s.filter(Boolean),t.seq=s.join("").replace(/\?/g,"-").toUpperCase(),n.push(t);return n}}function json2nexus(e){var t="";t+="#NEXUS",t+="\n",t+="Begin data;",t+="\n",t+="Dimensions ntax="+e.length+" nchar="+e[0].seq.length+";",t+="\n",t+="format datatype="+typeOfSequence(e)+" missing=? gap= -;",t+="\n",t+="Matrix",t+="\n";for(var n=0;n<e.length;n++)t+=e[n].name.replace(/\s/g,""),t+="	",t+=e[n].seq.toLowerCase(),t+="\n";return t+=";",t+="\n",t+="End;"}function validateGenbank(e){if(!e)return!1;var t,n=e.split("\n");if(n=n.filter(Boolean),!e.toUpperCase().startsWith("LOCUS"))return!1;if(!n[n.length-1].toUpperCase().replace(/\s/g,"").endsWith("//"))return!1;t=genbank2json(e);for(var r=0;r<t.length;r++){if(/[^\-\\.ABCDEFGHIKLMNPQRSTUVWXYZ\s]/i.test(t[r].seq))throw new Error("Sequence contains invalid symbols.");if(t[r].name="")return!1;if(t[r].seq="")return!1}return!0}function genbank2json(e){if(!e)return!1;var t,n,r=[],s=e.split("\n");s=s.filter(Boolean);for(var a=0;a<s.length;a++)if(t={},t.name="",t.seq="",t.description="",t.accession="",s[a].toUpperCase().startsWith("ACCESSION")&&(t.accession=" "+s[a].replace("ACCESSION","").trim()),s[a].toUpperCase().startsWith("DEFINITION")&&(n=" "+s[a].replace("DEFINITION","").trim()),s[a].replace(" ","").toUpperCase().startsWith("ORIGIN")){for(;+a+1<s.length&&!s[+a+1].startsWith("//");)a++,t.seq+=s[a].replace(/\s/g,"").replace(/[0-9]/g,"").toUpperCase();t.name+=(t.accession+" "+n).trim(),a++,r.push(t)}return r}function json2genbank(e){for(var t="",n=0;n<e.length;n++){t+="LOCUS						"+e[n].seq.length+" bp			"+typeOfSequence(e[n].seq),t+="\n",t+="DEFINITION		",t+=e[n].name,t+="\n",t+="ACCESSION		",t+=e[n].accession?e[n].accession:e[n].name.substring(0,10),t+="\n",t+="VERSION		",t+="\n",t+="KEYWORDS		",t+="\n",t+="SOURCE		",t+="\n",t+="ORGANISM		Location/Qualifiers",t+="\n",t+="ORIGIN",t+="\n";for(var r=e[n].seq.toLowerCase().match(/.{1,60}/g),s=0,a=0;a<r.length;a++){s=r[a].length+s;for(var i=0;i<9-s.toString().length;i++)t+=" ";t+=s,t+=" ",t+=addSpaceEveryNChars(r[a],10),t+="\n"}t+="//",t+="\n"}return t}function typeOfSequence(e){return/[^\-\\.AGUC\s]/i.test(e[0].seq)?/[^\-\\.AGTC\s]/i.test(e[0].seq)?/[^\-\\.ABCDEFGHIKLMNPQRSTUVWXYZ\s]/i.test(e[0].seq)?"undefined":"Protein":"DNA":"RNA"}function searchRegex(e,t,n){if(e&&t){var r,s,a,i,o=[];s=new RegExp(t,n);for(var l=0;l<e.length;l++)if(null!=e[l].seq.match(s)){var h={};a=0,i=0,r=e[l].seq.match(s);for(var f=[],u=0;u<r.length;u++){var c={};a=e[l].seq.indexOf(r[u],i+1),i=e[l].seq.indexOf(r[u],i+1)+r[u].length-1,c.endPos=a,c.startPos=i,f.push(c)}h.seq=e[l].seq,h.name=e[l].name,h.hit=f,o.push(h)}return o}}function consensus(e){if(!validateAlignment(e))return void console.log("not an alignment");for(var t=[],n=0;n<e[0].seq.length;n++)t.push("");for(var r="",n=0;n<e.length;n++)for(var s=0;s<e[n].seq.length;s++)t[s]+=e[n].seq[s];for(var a=0;a<t.length;a++)r+=getMax(t[a]);return r}function getFormat(e){return validateFasta(e)?"Fasta":validatea3m(e)?"A3M":validatePhylip(e)?"Phylip":validateClustal(e)?"Clustal":validateEMBL(e)?"EMBL":validateGenbank(e)?"Genbank":validateNexus(e)?"NEXUS":validatePir(e)?"PIR":validateStockholm(e)?"Stockholm":""}var getMax=function(e){var t=0,n="";return e.split("").forEach(function(r){e.split(r).length>t&&(t=e.split(r).length,n=r)}),n};!function(e){e.fn.reformat=function(e,t,n){var r=this.val(),s=getFormat(r);e=e.toUpperCase();var a=[],i="";switch(s){case"Fasta":a=fasta2json(r);break;case"A3M":a=a3m2json(r);break;case"Phylip":a=phylip2json(r);break;case"Clustal":a=clustal2json(r);break;case"Nexus":a=nexus2json(r);break;case"EMBL":a=embl2json(r);break;case"Genbank":a=genbank2json(r);break;case"PIR":a=pir2json(r);break;case"Stockholm":a=stockholm2json(r);break;default:a=null}switch(e){case"FASTA":i=json2fasta(a);break;case"A3M":i=json2a3m(a);break;case"PHYLIP":i=json2phylip(a);break;case"CLUSTAL":i=json2clustal(a);break;case"NEXUS":i=json2nexus(a);break;case"EMBL":i=json2embl(a);break;case"GENBANK":i=json2genbank(a);break;case"PIR":i=json2pir(a);break;case"STOCKHOLM":i=json2stockholm(a);break;case"UC":i=upperCase(a);break;case"LC":i=lowerCase(a);break;case"GETGIS":i=getGIs(a);break;case"GETACCESSIONS":i=getAccessionVersion(a);break;case"REGEX":i=searchRegex(a,t,n);break;case"CONSENSUS":i=consensus(a);break;case"DETECT":i=s;break;default:i=null}return i}}(jQuery);